{% load static %}
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriScope - ì¹´í…Œê³ ë¦¬ ë¶„ì„</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'dashboard/style.css' %}" />
    <style>
      /* ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */

      /* ìƒí’ˆ ëª©ë¡ ìŠ¤íƒ€ì¼ */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .product-item {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
        position: relative;
      }

      .product-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #0064ff;
        position: relative;
      }

      .product-item:hover .product-image {
        display: block;
      }

      .product-image {
        display: none;
        position: absolute;
        top: -30px;
        right: 200px;
        width: 150px;
        height: 150px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        border: 3px solid #fff;
        transition: all 0.3s ease;
      }

      .product-item:hover .product-image {
        transform: scale(1.05);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
      }

      .product-main {
        flex: 1;
      }

      .product-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #191f28;
        margin-bottom: 0.75rem;
      }

      .product-info {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #6b7280;
      }

      .info-badge {
        background: #f3f4f6;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
      }

      .brand {
        color: #0064ff;
      }

      .price {
        color: #dc2626;
        font-weight: 700;
      }

      .shop {
        color: #6b7280;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
      }

      .rank-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.125rem;
        min-width: 80px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        white-space: nowrap;
      }

      .rank-badge.top-1 {
        background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      }

      .rank-badge.top-10 {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      }

      .rank-badge.top-20 {
        background: linear-gradient(135deg, #374151 0%, #6b7280 100%);
      }

      .selected-category {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-left: 4px solid #0064ff;
      }

      /* ìƒí’ˆ ìƒì„¸ ì •ë³´ ì˜ì—­ */
      .product-details {
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: 16px;
        background: #fafbfc;
        border: 1px solid rgba(0, 0, 0, 0.04);
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .product-item {
          flex-direction: column;
          text-align: center;
          gap: 1rem;
        }

        .product-info {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="header-wrapper">
          <div class="logo-section">
            <span class="project-name">NutriScope</span>
          </div>
          <nav class="main-nav">
            <a href="{% url 'dashboard' %}" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
            <a href="{% url 'product_comparison' %}" class="nav-item"
              >ìƒí’ˆëª©ë¡</a
            >
            <a href="{% url 'compare_table' %}" class="nav-item">ìƒí’ˆë¹„êµ</a>
            <a href="{% url 'base' %}" class="nav-item">ìƒí’ˆë¦¬ìŠ¤íŠ¸</a>
            <a href="{% url 'category_price' %}" class="nav-item"
              >ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°</a
            >
            <a href="{% url 'mylist' %}" class="nav-item">ë­í‚¹</a>
            <a href="{% url 'category:index' %}" class="nav-item active"
              >ì¹´í…Œê³ ë¦¬ ë¶„ì„</a
            >
          </nav>
        </div>
        <div class="header-subtitle">
          <p>ì‡¼í•‘ëª° í¬ë¡¤ë§ ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
      </div>
    </div>
    <div class="container">
      <!-- ì¹´í…Œê³ ë¦¬ ë¶„ì„ ì„¹ì…˜ -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">ğŸ“Š</span>
            <span>ì¹´í…Œê³ ë¦¬ë³„ ìƒí’ˆ ë¶„ì„</span>
          </div>
          <div class="badge">CATEGORY</div>
        </div>
        <div class="two-col-grid">
          <div class="chart-container">
            <div id="chart" style="width: 100%; height: 100%"></div>
          </div>
          <div class="chart-container">
            <div id="chart-pie" style="width: 100%; height: 100%"></div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">ğŸ“¦</span>
            <span>ìƒí’ˆ ëª©ë¡ - ë­í‚¹ ìˆœ</span>
          </div>
          <div class="badge">PRODUCTS</div>
        </div>
        <div id="product-details" class="product-details">
          <h3
            id="selected-category-title"
            style="text-align: center; color: #6b7280; margin-bottom: 1.5rem"
          >
            ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”
          </h3>
          <div id="product-list" class="product-list"></div>
        </div>
      </div>

      <script>
        // ì „ì—­ ë³€ìˆ˜
        var chartData = {{ chart|safe }};
        var chartPieData = {{ chart_pie|safe }};
        var detailedData = {{ detailed_data|safe }};

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeChart() {
          Plotly.newPlot('chart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true
          });
        }

        function initializeChartPie() {
          Plotly.newPlot('chart-pie', chartPieData.data, chartPieData.layout, {
            responsive: true,
            displayModeBar: true
          });
        }

        // ìƒí’ˆ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
        function showCategoryProducts(category, count) {
          var productDetails = document.getElementById('product-details');
          var categoryTitle = document.getElementById('selected-category-title');
          var productList = document.getElementById('product-list');

          // ì œëª© ì—…ë°ì´íŠ¸
          categoryTitle.textContent = category + ' (' + count + 'ê°œ ìƒí’ˆ)';

          // ìƒí’ˆ ëª©ë¡ ìƒì„±
          var products = detailedData[category];
          var html = '';

          if (products && products.length > 0) {
            products.forEach(function(product) {
              var rankClass = '';
              var rankBadge = '';

              if (product.rank <= 20) {
                if (product.rank === 1) rankClass = 'top-1';
                else if (product.rank <= 10) rankClass = 'top-10';
                else if (product.rank <= 20) rankClass = 'top-20';

                rankBadge = '<div class="rank-badge ' + rankClass + '">' + product.shop_name.toUpperCase() + ' ' + product.rank + 'ìœ„</div>';
              }

              html += '<div class="product-item">';
              if (product.image_url) {
                html += '  <div class="product-image" style="background-image: url(' + product.image_url + ')"></div>';
              }
              html += '  <div class="product-main">';
              html += '    <div class="product-name">' + product.product_name + '</div>';
              html += '    <div class="product-info">';
              html += '      <span class="info-badge brand">ğŸ·ï¸ ' + (product.brand_name || 'N/A') + '</span>';
              html += '      <span class="info-badge price">ğŸ’° ' + (product.sale_price ? product.sale_price.toLocaleString() + 'ì›' : 'N/A') + '</span>';
              html += '      <span class="info-badge shop">ğŸª ' + product.shop_name + '</span>';
              html += '    </div>';
              html += '  </div>';
              html += rankBadge;
              html += '</div>';
            });
          } else {
            html = '<p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }

          productList.innerHTML = html;
          productDetails.style.display = 'block';
          productDetails.scrollIntoView({ behavior: 'smooth' });
        }

         // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ë§‰ëŒ€ ì°¨íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('chart').on('plotly_click', function(data){
            var clickedCategory = data.points[0].x;
            var productCount = data.points[0].y;

            console.log('ë§‰ëŒ€ ì°¨íŠ¸ í´ë¦­ - ì¹´í…Œê³ ë¦¬:', clickedCategory, 'ìƒí’ˆ ìˆ˜:', productCount);
            showCategoryProducts(clickedCategory, productCount);
          });

            // ì›í˜• ì°¨íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('chart-pie').on('plotly_click', function(data){
              var clickedCategory = data.points[0].label;
              var productCount = data.points[0].value;

              console.log('ì›í˜• ì°¨íŠ¸ í´ë¦­ - ì¹´í…Œê³ ë¦¬:', clickedCategory, 'ìƒí’ˆ ìˆ˜:', productCount);
              showCategoryProducts(clickedCategory, productCount);
            });

          }

        // ë¸Œë¼ìš°ì € í¬ê¸° ë³€í™” ê°ì§€ ë° ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
        function handleResize() {
          Plotly.Plots.resize('chart');
          Plotly.Plots.resize('chart-pie');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
          initializeChart();
          initializeChartPie();
          setupEventListeners();

          // ë¸Œë¼ìš°ì € í¬ê¸° ë³€í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          window.addEventListener('resize', handleResize);
        });
      </script>
    </div>
  </body>
</html>
