{% load static %}
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriScope - 카테고리 분석</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'dashboard/style.css' %}" />
    <style>
      /* 카테고리 페이지 전용 스타일 */

      /* 상품 목록 스타일 */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .product-item {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
        position: relative;
      }

      .product-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #0064ff;
        position: relative;
      }

      .product-item:hover .product-image {
        display: block;
      }

      .product-image {
        display: none;
        position: absolute;
        top: -30px;
        right: 200px;
        width: 150px;
        height: 150px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        border: 3px solid #fff;
        transition: all 0.3s ease;
      }

      .product-item:hover .product-image {
        transform: scale(1.05);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
      }

      .product-main {
        flex: 1;
      }

      .product-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #191f28;
        margin-bottom: 0.75rem;
      }

      .product-info {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #6b7280;
      }

      .info-badge {
        background: #f3f4f6;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
      }

      .brand {
        color: #0064ff;
      }

      .price {
        color: #dc2626;
        font-weight: 700;
      }

      .shop {
        color: #6b7280;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
      }

      .rank-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.125rem;
        min-width: 80px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        white-space: nowrap;
      }

      .rank-badge.top-1 {
        background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      }

      .rank-badge.top-10 {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      }

      .rank-badge.top-20 {
        background: linear-gradient(135deg, #374151 0%, #6b7280 100%);
      }

      .selected-category {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-left: 4px solid #0064ff;
      }

      /* 상품 상세 정보 영역 */
      .product-details {
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: 16px;
        background: #fafbfc;
        border: 1px solid rgba(0, 0, 0, 0.04);
      }

      /* 반응형 디자인 */
      @media (max-width: 768px) {
        .product-item {
          flex-direction: column;
          text-align: center;
          gap: 1rem;
        }

        .product-info {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="header-wrapper">
          <div class="logo-section">
            <span class="project-name">NutriScope</span>
          </div>
          <nav class="main-nav">
            <a href="{% url 'dashboard' %}" class="nav-item">대시보드</a>
            <a href="{% url 'product_comparison' %}" class="nav-item"
              >상품목록</a
            >
            <a href="{% url 'compare_table' %}" class="nav-item">상품비교</a>
            <a href="{% url 'base' %}" class="nav-item">상품리스트</a>
            <a href="{% url 'category_price' %}" class="nav-item"
              >카테고리별 보기</a
            >
            <a href="{% url 'mylist' %}" class="nav-item">랭킹</a>
            <a href="{% url 'category:index' %}" class="nav-item active"
              >카테고리 분석</a
            >
          </nav>
        </div>
        <div class="header-subtitle">
          <p>쇼핑몰 크롤링 데이터 분석 결과를 한눈에 확인하세요</p>
        </div>
      </div>
    </div>
    <div class="container">
      <!-- 카테고리 분석 섹션 -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">📊</span>
            <span>카테고리별 상품 분석</span>
          </div>
          <div class="badge">CATEGORY</div>
        </div>
        <div class="two-col-grid">
          <div class="chart-container">
            <div id="chart" style="width: 100%; height: 100%"></div>
          </div>
          <div class="chart-container">
            <div id="chart-pie" style="width: 100%; height: 100%"></div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- 상품 목록 섹션 -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">📦</span>
            <span>상품 목록 - 랭킹 순</span>
          </div>
          <div class="badge">PRODUCTS</div>
        </div>
        <div id="product-details" class="product-details">
          <h3
            id="selected-category-title"
            style="text-align: center; color: #6b7280; margin-bottom: 1.5rem"
          >
            카테고리를 선택하세요
          </h3>
          <div id="product-list" class="product-list"></div>
        </div>
      </div>

      <script>
        // 전역 변수
        var chartData = {{ chart|safe }};
        var chartPieData = {{ chart_pie|safe }};
        var detailedData = {{ detailed_data|safe }};

        // 차트 초기화
        function initializeChart() {
          Plotly.newPlot('chart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true
          });
        }

        function initializeChartPie() {
          Plotly.newPlot('chart-pie', chartPieData.data, chartPieData.layout, {
            responsive: true,
            displayModeBar: true
          });
        }

        // 상품 목록 표시 함수
        function showCategoryProducts(category, count) {
          var productDetails = document.getElementById('product-details');
          var categoryTitle = document.getElementById('selected-category-title');
          var productList = document.getElementById('product-list');

          // 제목 업데이트
          categoryTitle.textContent = category + ' (' + count + '개 상품)';

          // 상품 목록 생성
          var products = detailedData[category];
          var html = '';

          if (products && products.length > 0) {
            products.forEach(function(product) {
              var rankClass = '';
              var rankBadge = '';

              if (product.rank <= 20) {
                if (product.rank === 1) rankClass = 'top-1';
                else if (product.rank <= 10) rankClass = 'top-10';
                else if (product.rank <= 20) rankClass = 'top-20';

                rankBadge = '<div class="rank-badge ' + rankClass + '">' + product.shop_name.toUpperCase() + ' ' + product.rank + '위</div>';
              }

              html += '<div class="product-item">';
              if (product.image_url) {
                html += '  <div class="product-image" style="background-image: url(' + product.image_url + ')"></div>';
              }
              html += '  <div class="product-main">';
              html += '    <div class="product-name">' + product.product_name + '</div>';
              html += '    <div class="product-info">';
              html += '      <span class="info-badge brand">🏷️ ' + (product.brand_name || 'N/A') + '</span>';
              html += '      <span class="info-badge price">💰 ' + (product.sale_price ? product.sale_price.toLocaleString() + '원' : 'N/A') + '</span>';
              html += '      <span class="info-badge shop">🏪 ' + product.shop_name + '</span>';
              html += '    </div>';
              html += '  </div>';
              html += rankBadge;
              html += '</div>';
            });
          } else {
            html = '<p>해당 카테고리에 상품이 없습니다.</p>';
          }

          productList.innerHTML = html;
          productDetails.style.display = 'block';
          productDetails.scrollIntoView({ behavior: 'smooth' });
        }

         // 이벤트 리스너 설정
        function setupEventListeners() {
            // 막대 차트 클릭 이벤트
            document.getElementById('chart').on('plotly_click', function(data){
            var clickedCategory = data.points[0].x;
            var productCount = data.points[0].y;

            console.log('막대 차트 클릭 - 카테고리:', clickedCategory, '상품 수:', productCount);
            showCategoryProducts(clickedCategory, productCount);
          });

            // 원형 차트 클릭 이벤트
            document.getElementById('chart-pie').on('plotly_click', function(data){
              var clickedCategory = data.points[0].label;
              var productCount = data.points[0].value;

              console.log('원형 차트 클릭 - 카테고리:', clickedCategory, '상품 수:', productCount);
              showCategoryProducts(clickedCategory, productCount);
            });

          }

        // 브라우저 크기 변화 감지 및 차트 리사이즈
        function handleResize() {
          Plotly.Plots.resize('chart');
          Plotly.Plots.resize('chart-pie');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
          initializeChart();
          initializeChartPie();
          setupEventListeners();

          // 브라우저 크기 변화 이벤트 리스너 추가
          window.addEventListener('resize', handleResize);
        });
      </script>
    </div>
  </body>
</html>
