{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriScope - ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- ëª¨ë‹¬ -->
    <div class="modal fade" id="brandDetailModal" tabindex="-1" aria-labelledby="brandDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="brandDetailModalLabel">ë¸Œëœë“œ ìƒì„¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body" id="brandDetailChart">
                ...
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
            
            </div>
        </div>
    </div>
    <div class="header">
      <div class="header-content">
        <div class="header-wrapper">
          <div class="logo-section">
            <span class="project-name">NutriScope</span>
          </div>
          <nav class="main-nav">
            <a href="{% url 'dashboard' %}" class="nav-item active">ëŒ€ì‹œë³´ë“œ</a>
            <a href="{% url 'product_comparison' %}" class="nav-item">ìƒí’ˆëª©ë¡</a>
            <a href="{% url 'compare_table' %}" class="nav-item">ìƒí’ˆë¹„êµ</a>
            <a href="{% url 'base' %}" class="nav-item">ìƒí’ˆë¦¬ìŠ¤íŠ¸</a>
            <a href="{% url 'category_price' %}" class="nav-item">ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°</a>
            <a href="{% url 'mylist' %}" class="nav-item">ë­í‚¹</a>
            <a href="{% url 'category:index' %}" class="nav-item">ì¹´í…Œê³ ë¦¬ ë¶„ì„</a>
          </nav>
        </div>
        <div class="header-subtitle">
          <p>ì‡¼í•‘ëª° í¬ë¡¤ë§ ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-label">ì´ ì œí’ˆ ìˆ˜</div>
          </div>
          <div class="stat-value-container">
            <span class="stat-value"
              >{{ stats.total_products|floatformat:0 }}</span
            >
            <span class="stat-unit">ê°œ</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-label">í‰ê·  ê°€ê²©</div>
          </div>
          <div class="stat-value-container">
            <span class="stat-value">{{ stats.avg_price|floatformat:0 }}</span>
            <span class="stat-unit">ì›</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">ğŸ·ï¸</div>
            <div class="stat-label">ë¸Œëœë“œ ìˆ˜</div>
          </div>
          <div class="stat-value-container">
            <span class="stat-value">{{ stats.total_brands }}</span>
            <span class="stat-unit">ê°œ</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-label">ì¹´í…Œê³ ë¦¬ ìˆ˜</div>
          </div>
          <div class="stat-value-container">
            <span class="stat-value">{{ stats.total_categories }}</span>
            <span class="stat-unit">ê°œ</span>
          </div>
        </div>
      </div>

      <!-- ê°€ê²© ë¶„í¬ ì„¹ì…˜ -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">ğŸ’°</span>
            <span>ê°€ê²© ë¶„í¬ ë¶„ì„</span>
          </div>
          <div class="badge">PRICE</div>
        </div>
        <div class="two-col-grid">
          <div class="chart-container" id="histogram"></div>
          <div class="chart-container" id="boxplot"></div>
        </div>
      </div>

      <div class="divider"></div>


      <!-- ë¸Œëœë“œ ë¶„ì„ ì„¹ì…˜ -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">ğŸ†</span>
            <span>ì¸ê¸° ë¸Œëœë“œ Top 10</span>
          </div>
          <div class="badge">BRAND</div>
        </div>
        <div class="two-col-grid">
          <div class="chart-container" id="brand-bar"></div>
          <div class="chart-container" id="brand-pie"></div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- ì¹´í…Œê³ ë¦¬ ë¶„ì„ ì„¹ì…˜ -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon">ğŸ“Š</span>
            <span>ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„</span>
          </div>
          <div class="badge">CATEGORY</div>
        </div>
        <div class="two-col-grid">
          <div class="chart-container" id="category-bar"></div>
          <div class="chart-container" id="category-tree"></div>
        </div>
      </div>
    </div>

    <script>
        // Djangoì—ì„œ ì „ë‹¬ë°›ì€ Plotly JSON ë°ì´í„° íŒŒì‹±
        const histogramData = JSON.parse('{{ histogram_json|escapejs }}');
        const boxData = JSON.parse('{{ box_json|escapejs }}');
        const brandBarData = JSON.parse('{{ brand_bar_json|escapejs }}');
        const brandPieData = JSON.parse('{{ brand_pie_json|escapejs }}');
        const categoryBarData = JSON.parse('{{ category_bar_json|escapejs }}');
        const categoryTreeData = JSON.parse('{{ category_tree_json|escapejs }}');
        const charDiv = document.getElementById('brand-bar');

        const commonConfig = {
          responsive: true,
          displayModeBar: false,
        };

        // Plotly ì°¨íŠ¸ ë Œë”ë§
        if (histogramData && histogramData.data) Plotly.newPlot('histogram', histogramData.data, histogramData.layout, commonConfig);
        if (boxData && boxData.data) Plotly.newPlot('boxplot', boxData.data, boxData.layout, commonConfig);
        if (brandBarData && brandBarData.data) Plotly.newPlot('brand-bar', brandBarData.data, brandBarData.layout, commonConfig);
        if (brandPieData && brandPieData.data) Plotly.newPlot('brand-pie', brandPieData.data, brandPieData.layout, commonConfig);
        if (categoryBarData && categoryBarData.data) Plotly.newPlot('category-bar', categoryBarData.data, categoryBarData.layout, commonConfig);
        if (categoryTreeData && categoryTreeData.data) Plotly.newPlot('category-tree', categoryTreeData.data, categoryTreeData.layout, commonConfig);

        charDiv.on('plotly_click', function(data) {
            let brand_name = data.points[0].y;
            console.log(brand_name)
            const modal = new bootstrap.Modal(document.getElementById('brandDetailModal'));
            const modalEl = document.getElementById('brandDetailModal');
            // ëª¨ë‹¬ ì—´ê¸°
            modal.show();

            // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('brandDetailModalLabel').innerText = `${brand_name} - ì œí’ˆ ì¶”ì´`;

            axios.get(`/famous_brand/detail/?brand_name=${brand_name}`)
                    .then(function (response) {
                        let graphJson = response.data;
                        console.log(response)

                        // ëª¨ë‹¬ ë‚´ë¶€ div ë¹„ìš°ê³  ìƒˆë¡œìš´ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
                        let detailDiv = document.getElementById('brandDetailChart');
                        detailDiv.innerHTML = "";

                        Plotly.newPlot(detailDiv, graphJson.data, graphJson.layout);
                    })
                    .catch(function (error) {
                        console.error(error);
                        document.getElementById('brandDetailChart').innerHTML = "ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨";
                    })

        })
    </script>

</body>

</html>
