{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriScope - 카테고리별 가격 분석</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/style.css' %}">
    <style>
        .price-analysis-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .price-analysis-title {
            font-size: 2rem;
            font-weight: 700;
            color: #191f28;
            margin-bottom: 0.5rem;
        }

        .price-analysis-desc {
            font-size: 1rem;
            color: #6b7280;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
        }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f3f5;
        }

        .chart-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #191f28;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-icon {
            font-size: 1.5rem;
        }

        .selected-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
            color: #0064FF;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .chart-wrapper {
            background: #fafbfc;
            border-radius: 12px;
            padding: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s ease;
        }

        .form-control {
            flex: 1;
        }

        .form-select {
            min-width: 150px;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #0064FF;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: #0064FF;
            color: white;
        }

        .btn-secondary:hover {
            background: #0052CC;
            transform: translateY(-1px);
        }

        .btn-outline-secondary {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-outline-secondary:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #0064FF;
            color: #0064FF;
        }

        .btn-outline-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .product-image-wrapper {
            flex-shrink: 0;
            width: 200px;
        }

        .product-image-wrapper img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .product-info h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #191f28;
            margin-bottom: 0.75rem;
        }

        .product-info p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0.25rem 0;
        }

        .product-info strong {
            color: #191f28;
            font-weight: 600;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pagination-info {
            font-size: 0.875rem;
            font-weight: 600;
            color: #191f28;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 8px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .price-analysis-title {
                font-size: 1.5rem;
            }

            .chart-card {
                padding: 1.5rem;
            }

            .chart-wrapper {
                min-height: 300px;
            }

            .search-controls {
                flex-direction: column;
            }

            .product-card {
                flex-direction: column;
            }

            .product-image-wrapper {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-wrapper">
                <div class="logo-section">
                    <span class="project-name">NutriScope</span>
                </div>
                <nav class="main-nav">
                    <a href="{% url 'dashboard' %}" class="nav-item">대시보드</a>
                    <a href="{% url 'product_comparison' %}" class="nav-item">상품목록</a>
                    <a href="{% url 'compare_table' %}" class="nav-item">상품비교</a>
                    <a href="{% url 'base' %}" class="nav-item">상품리스트</a>
                    <a href="{% url 'category_price' %}" class="nav-item active">카테고리별 보기</a>
                </nav>
            </div>
            <div class="header-subtitle">
                <p>쇼핑몰 크롤링 데이터 분석 결과를 한눈에 확인하세요</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="price-analysis-header">
            <h1 class="price-analysis-title">📊 카테고리별 가격 분석</h1>
            <p class="price-analysis-desc">트리맵에서 카테고리를 클릭하면 해당 카테고리의 가격대별 분포 및 상품 목록을 확인할 수 있습니다</p>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">
                        <span class="chart-icon">📦</span>
                        카테고리별 제품 수
                    </h3>
                </div>
                <div class="chart-wrapper">
                    <div id="treemap"></div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">
                        <span class="chart-icon">💰</span>
                        가격대별 제품 수
                    </h3>
                    <span class="selected-badge" id="selected-category">전체</span>
                </div>
                <div class="chart-wrapper">
                    <div id="barchart"></div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="section-title">상품 목록</h2>
            
            <div class="search-controls">
                <input type="text" class="form-control" id="search-title" placeholder="상품명, 브랜드, 쇼핑몰 검색">
                <select id="sort-select" class="form-select">
                    <option value="id-asc" selected>ID 오름차순</option>
                    <option value="id-desc">ID 내림차순</option>
                    <option value="price-asc">가격 오름차순</option>
                    <option value="price-desc">가격 내림차순</option>
                </select>
                <button class="btn btn-secondary" id="search-btn">검색</button>
            </div>

            <div id="product-list"></div>
            
            <div class="pagination-container">
                <button class="btn btn-outline-secondary" id="previous">이전</button>
                <span class="pagination-info" id="pagination-info">1 / 1</span>
                <button class="btn btn-outline-secondary" id="next">다음</button>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const treemapUrl = "{% url 'get_treemap_data' %}";
        const barchartUrl = "{% url 'get_barchart_data' %}";

        let allProducts = [];
        let products = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let totalPages = 1;
        let currentCategory = "All";

        const colorScale = d3.scaleOrdinal()
            .range(['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#00BCD4', '#FFEB3B', '#795548']);

        // 트리맵 렌더링
        function renderTreemap(data) {
            const containerWidth = document.getElementById('treemap').parentElement.clientWidth;
            const width = containerWidth - 32;
            const height = 400;
            
            const root = d3.hierarchy({children: data})
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);

            d3.treemap()
                .size([width, height])
                .padding(2)
                .round(true)(root);

            const svg = d3.select("#treemap")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const nodes = svg.selectAll("g")
                .data(root.leaves())
                .enter().append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`)
                .on("click", (event, d) => {
                    currentCategory = d.data.category;
                    updateBarChart(currentCategory);
                    filterProductsByCategory(currentCategory);
                    document.getElementById('selected-category').textContent = currentCategory;
                });

            nodes.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", (d, i) => colorScale(i))
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .attr("rx", 4);

            nodes.append("text")
                .attr("x", d => (d.x1 - d.x0) / 2)
                .attr("y", d => (d.y1 - d.y0) / 2 - 5)
                .attr("text-anchor", "middle")
                .attr("font-size", d => {
                    const width = d.x1 - d.x0;
                    return Math.min(width / 8, 14) + "px";
                })
                .attr("fill", "white")
                .attr("font-weight", "600")
                .text(d => d.data.category);

            nodes.append("text")
                .attr("x", d => (d.x1 - d.x0) / 2)
                .attr("y", d => (d.y1 - d.y0) / 2 + 10)
                .attr("text-anchor", "middle")
                .attr("font-size", "11px")
                .attr("fill", "white")
                .text(d => `${d.data.value}개`);
        }

        // 바차트 렌더링
        function updateBarChart(category = "All") {
            const url = `${barchartUrl}?category=${encodeURIComponent(category)}`;
            
            d3.json(url).then(data => {
                d3.select("#barchart").html("");
                
                const containerWidth = document.getElementById('barchart').parentElement.clientWidth;
                const margin = {top: 20, right: 20, bottom: 70, left: 60};
                const width = containerWidth - 32 - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select("#barchart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .domain(data.map(d => d.category))
                    .range([0, width])
                    .padding(0.3);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.value) * 1.15])
                    .nice()
                    .range([height, 0]);

                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .attr("transform", "rotate(-20)")
                    .style("text-anchor", "end")
                    .style("font-size", "11px");

                svg.append("g")
                    .attr("class", "axis")
                    .call(d3.axisLeft(y).ticks(6));

                svg.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.category))
                    .attr("width", x.bandwidth())
                    .attr("y", height)
                    .attr("height", 0)
                    .attr("fill", "#FF6B6B")
                    .attr("rx", 6)
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.value))
                    .attr("height", d => height - y(d.value));

                svg.selectAll(".bar-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "bar-label")
                    .attr("x", d => x(d.category) + x.bandwidth() / 2)
                    .attr("y", height)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#191f28")
                    .attr("font-weight", "600")
                    .attr("font-size", "12px")
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.value) - 8)
                    .text(d => d.value);
            });
        }

        // 상품 로드
        async function loadProducts() {
            try {
                const response = await fetch("{% url 'product_list_api' %}");
                allProducts = await response.json();
                products = [...allProducts];
                sortProducts('id-asc');
                totalPages = Math.ceil(products.length / itemsPerPage);
                displayProductsForPage(currentPage);
            } catch (error) {
                console.error(error);
                document.getElementById('product-list').innerHTML = '<p>상품을 불러오는데 실패했습니다.</p>';
            }
        }

        // 카테고리로 필터링
        function filterProductsByCategory(category) {
            const keyword = document.getElementById('search-title').value.trim().toLowerCase();
            
            if (category === "All") {
                products = [...allProducts];
            } else {
                products = allProducts.filter(p => p.category === category);
            }

            if (keyword) {
                products = products.filter(p =>
                    p.product_name.toLowerCase().includes(keyword) ||
                    p.brand_name.toLowerCase().includes(keyword) ||
                    p.shop_name.toLowerCase().includes(keyword)
                );
            }

            const sortOption = document.getElementById('sort-select').value;
            sortProducts(sortOption);
            currentPage = 1;
            totalPages = Math.ceil(products.length / itemsPerPage);
            displayProductsForPage(currentPage);
        }

        // 정렬
        function sortProducts(option) {
            switch(option) {
                case 'id-asc': products.sort((a,b) => a.id - b.id); break;
                case 'id-desc': products.sort((a,b) => b.id - a.id); break;
                case 'price-asc': products.sort((a,b) => a.sale_price - b.sale_price); break;
                case 'price-desc': products.sort((a,b) => b.sale_price - a.sale_price); break;
            }
        }

        // 페이지별 상품 표시
        function displayProductsForPage(page) {
            const start = (page - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, products.length);
            const currentItems = products.slice(start, end);
            const listContainer = document.getElementById('product-list');
            listContainer.innerHTML = '';

            if (currentItems.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; padding:2rem; color:#6b7280;">표시할 상품이 없습니다.</p>';
                return;
            }

            currentItems.forEach(p => {
                listContainer.innerHTML += `
                    <div class="product-card">
                        <div class="product-image-wrapper">
                            <img src="${p.image_url}" alt="${p.product_name}">
                        </div>
                        <div class="product-info">
                            <h3>${p.id}. ${p.product_name}</h3>
                            <p><strong>Shop:</strong> ${p.shop_name}</p>
                            <p><strong>Brand:</strong> ${p.brand_name}</p>
                            <p><strong>Quantity:</strong> ${p.quantity}</p>
                            <p><strong>Price:</strong> ${p.sale_price.toLocaleString()}원</p>
                        </div>
                    </div>
                `;
            });

            document.getElementById('pagination-info').innerText = `${page} / ${totalPages}`;
            document.getElementById('previous').disabled = (page === 1);
            document.getElementById('next').disabled = (page === totalPages);
        }

        // 검색 버튼
        document.getElementById('search-btn').addEventListener('click', function() {
            filterProductsByCategory(currentCategory);
        });

        // 정렬 변경
        document.getElementById('sort-select').addEventListener('change', function() {
            sortProducts(this.value);
            currentPage = 1;
            displayProductsForPage(currentPage);
        });

        // 페이지네이션
        document.getElementById('next').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                displayProductsForPage(currentPage);
            }
        });

        document.getElementById('previous').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayProductsForPage(currentPage);
            }
        });

        // 초기 로딩
        Promise.all([
            d3.json(treemapUrl),
            d3.json(`${barchartUrl}?category=All`)
        ]).then(([treemapData, barchartData]) => {
            renderTreemap(treemapData);
            updateBarChart("All");
            loadProducts();
        });

        // 반응형 처리
        window.addEventListener('resize', () => {
            d3.select("#treemap").html("");
            d3.select("#barchart").html("");
            
            d3.json(treemapUrl).then(treemapData => {
                renderTreemap(treemapData);
                updateBarChart(currentCategory);
            });
        });
    </script>
</body>
</html>